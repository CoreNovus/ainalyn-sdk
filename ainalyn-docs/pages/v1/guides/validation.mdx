# Validation

How validation works and what gets checked.

## What Gets Validated

The SDK validates your agent definition before export to keep it ready for review.

**Schema Validation:**
- Required fields present
- Name and version format
- References resolve

**Review Gates:**
- Contract completeness (goal, completion criteria, schemas)
- No shadow runtime patterns
- Result sovereignty
- Billing hint only
- EIP dependency declarations

**Static Analysis:**
- Cycles in workflows
- Unreachable nodes
- Unused resources

## Using validate()

```python
from ainalyn import AgentBuilder, validate

agent = (
    AgentBuilder("MyAgent")
    .version("1.0.0")
    .description("My first agent")
    .add_workflow(workflow)
    .build()
)

# Validate
result = validate(agent)

if result.is_valid:
    print("Validation passed!")
else:
    print("Validation failed:")
    for error in result.errors:
        print(f"  {error.code}: {error.message}")
```

## Validation Results

The `ValidationResult` object contains:

**Properties:**
- `is_valid` - Boolean indicating if validation passed
- `has_warnings` - True if any WARNING-level issues exist
- `errors` - Tuple of errors and warnings

**Error Details:**
Each error contains:
- `code` - Error code (e.g., "MISSING_AGENT_VERSION")
- `path` - Location in the definition (e.g., "agent.version")
- `message` - Human-readable description
- `severity` - ERROR or WARNING

## Naming Rules

**Valid names:**
```python
"my-agent"          # Letters, numbers, hyphens
"MyAgent"           # Uppercase allowed
"my_agent"         # Underscore allowed
"agent-123"         # Numbers allowed
```

**Invalid names:**
```python
"my agent"     # No spaces
"my@agent"     # No special symbols
"my.agent"     # No dots
```

## Version Format


**Valid versions:**
```python
"1.0.0"        # MAJOR.MINOR.PATCH
"2.1.3"
"0.1.0"
```

**Invalid versions:**
```python
"1.0"          # Must have three parts
"v1.0.0"       # No 'v' prefix
"1.0.0-beta"   # Pre-release not allowed
```

## Common Validation Errors

### MISSING_AGENT_VERSION

**Cause:** Forgot to set agent version.

```python
# Error
agent = AgentBuilder("my-agent").build()

# Fix
agent = AgentBuilder("my-agent").version("1.0.0").build()
```

### INVALID_WORKFLOW_NAME

**Cause:** Workflow name doesn't follow naming rules.

```python
# Error
workflow = WorkflowBuilder("MyWorkflow").build()

# Fix
workflow = WorkflowBuilder("my-workflow").build()
```

### MISSING_WORKFLOWS

**Cause:** Agent has no workflows.

```python
# Error
agent = AgentBuilder("my-agent").version("1.0.0").build()

# Fix
agent = (
    AgentBuilder("my-agent")
    .version("1.0.0")
    .add_workflow(workflow)
    .build()
)
```

### UNDEFINED_RESOURCE_REFERENCE

**Cause:** Node references a resource that doesn't exist.

```python
# Error - prompt not defined
node = (
    NodeBuilder("task")
    .description("Task node")
    .uses_prompt("analyzer")  # No prompt named "analyzer"
    .build()
)

# Fix - define the prompt first
prompt = PromptBuilder("analyzer").template("Analyze: {data}").build()

agent = (
    AgentBuilder("my-agent")
    .version("1.0.0")
    .add_prompt(prompt)  # Add prompt to agent
    .add_workflow(workflow)
    .build()
)
```

### INVALID_ENTRY_NODE

**Cause:** Workflow entry_node doesn't exist in nodes.

```python
# Error
workflow = (
    WorkflowBuilder("process")
    .entry_node("start")  # No node named "start"
    .add_node(NodeBuilder("step1").goal("Do something").build())
    .build()
)

# Fix
workflow = (
    WorkflowBuilder("process")
    .entry_node("step1")  # Valid node name
    .add_node(NodeBuilder("step1").goal("Do something").build())
    .build()
)
```

## Best Practices

**1. Validate early and often**

```python
# Build progressively, validate at each step
node = NodeBuilder("task").goal("Process data").build()
workflow = WorkflowBuilder("main").add_node(node).build()
agent = AgentBuilder("my-agent").version("1.0.0").add_workflow(workflow).build()

# Validate before export
result = validate(agent)
if not result.is_valid:
    print("Fix these errors before exporting:")
    for error in result.errors:
        print(f"  - {error.message}")
```

**2. Check validation results**

```python
result = validate(agent)

# Don't ignore validation!
if not result.is_valid:
    raise ValueError(f"Invalid agent: {result.errors[0].message}")

# Now safe to export
yaml_output = export_yaml(agent)
```

**3. Use compile_agent() for safety**

```python
from ainalyn.api import compile_agent
from pathlib import Path

# Automatically validates before exporting
result = compile_agent(agent, Path("agent.yaml"))

if result.is_successful:
    print(f"Compiled to {result.output_path}")
else:
    print("Compilation failed:")
    for error in result.validation_result.errors:
        print(f"  {error.message}")
```

## When Validation Happens

**Builder validation:**
- Happens during `.build()` call
- Checks required fields
- Validates value formats
- Throws exceptions immediately

**Validation:**
- Happens when you call `validate()`
- Checks schema, review gates, and static analysis
- Returns ValidationResult
- Does not throw exceptions

**Example:**

```python
# Builder validation - throws exception
try:
    agent = AgentBuilder("Invalid Name!").build()  # Throws exception
except InvalidValueError as e:
    print(f"Builder error: {e.message}")

# Schema validation - returns result
agent = AgentBuilder("my-agent").version("1.0.0").build()
result = validate(agent)  # Returns ValidationResult

if not result.is_valid:
    print(f"Schema error: {result.errors[0].message}")
```

## See Also

- [Error Handling](/v1/guides/errors/) - Builder errors and how to fix them
- [API Reference](/v1/api-reference/api/) - validate() function details
- [Builders](/v1/api-reference/builders/) - Builder validation rules
